# 植物病害检测系统 - 微服务架构设计

## 系统概述

本系统采用微服务架构，将植物病害检测功能拆分为多个独立的服务，通过异步任务处理和Redis缓存提高系统性能和响应速度。

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端应用层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  Web前端     │  │  移动应用    │  │  第三方集成   │             │
│  │  (React)    │  │  (React Native)│  │  (REST API) │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          │ HTTPS/WSS
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API网关层                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              API Gateway (Kong/Nginx)                      │ │
│  │  - 路由转发  - 限流控制  - 认证授权  - 请求日志            │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      应用服务层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  用户服务    │  │  任务服务    │  │  通知服务    │             │
│  │  (FastAPI)  │  │  (FastAPI)  │  │  (FastAPI)  │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      任务队列层                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              消息队列 (RabbitMQ/Redis Streams)              │ │
│  │  - 任务分发  - 任务路由  - 任务重试  - 死信队列            │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      模型服务层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  预测服务    │  │  分割服务    │  │  分析服务    │             │
│  │  (FastAPI)  │  │  (FastAPI)  │  │  (FastAPI)  │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据存储层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   Redis     │  │   PostgreSQL │  │   腾讯云COS   │             │
│  │   (缓存)     │  │   (关系数据)  │  │   (对象存储)  │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

## 核心服务说明

### 1. API网关服务
- **功能**: 统一入口，路由转发，认证授权，限流控制
- **技术**: Kong/Nginx + Lua
- **端口**: 80/443

### 2. 用户服务
- **功能**: 用户注册、登录、权限管理
- **技术**: FastAPI + PostgreSQL + Redis
- **端口**: 8001

### 3. 任务服务
- **功能**: 任务创建、状态查询、结果获取
- **技术**: FastAPI + Redis + PostgreSQL
- **端口**: 8002

### 4. 模型服务
- **功能**: 模型加载、预测处理、结果缓存
- **技术**: FastAPI + PyTorch + Redis
- **端口**: 8003

### 5. 分割服务
- **功能**: 图像分割、预处理、后处理
- **技术**: FastAPI + OpenCV + Redis
- **端口**: 8004

### 6. 通知服务
- **功能**: 任务完成通知、结果推送
- **技术**: FastAPI + WebSocket/邮件
- **端口**: 8005

## 数据流设计

### 图像检测流程

1. **前端上传**
   - 用户通过前端上传图像
   - 前端发送请求到API网关

2. **任务创建**
   - API网关转发请求到任务服务
   - 任务服务创建任务记录，返回任务ID
   - 任务服务将任务推送到消息队列

3. **异步处理**
   - 模型服务从队列获取任务
   - 模型服务加载图像，进行预测
   - 如需分割，调用分割服务

4. **结果存储**
   - 预测结果存储到PostgreSQL
   - 结果缓存到Redis
   - 原始图像和结果图像存储到COS

5. **结果通知**
   - 任务状态更新为完成
   - 通知服务发送通知给前端
   - 前端通过WebSocket或轮询获取结果

## 技术栈

### 后端服务
- **框架**: FastAPI
- **异步**: asyncio + uvicorn
- **任务队列**: Celery + Redis/RabbitMQ
- **数据库**: PostgreSQL
- **缓存**: Redis
- **对象存储**: 腾讯云COS

### 前端应用
- **Web**: React + TypeScript + Ant Design
- **移动**: React Native
- **状态管理**: Redux/Redux Toolkit
- **HTTP客户端**: Axios
- **实时通信**: WebSocket

### 基础设施
- **容器化**: Docker + Docker Compose
- **编排**: Kubernetes (可选)
- **API网关**: Kong/Nginx
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack (Elasticsearch + Logstash + Kibana)

## 部署架构

### 开发环境
```
docker-compose.dev.yml
├── api-gateway (Nginx)
├── user-service (FastAPI)
├── task-service (FastAPI)
├── model-service (FastAPI)
├── segmentation-service (FastAPI)
├── notification-service (FastAPI)
├── redis (缓存 + 消息队列)
├── postgres (数据库)
└── frontend (React)
```

### 生产环境
```
Kubernetes集群
├── Ingress Controller (API网关)
├── 微服务Pod (各服务实例)
├── StatefulSet (数据库)
├── Deployment (无状态服务)
├── Service (服务发现)
├── ConfigMap (配置管理)
└── PersistentVolume (持久化存储)
```

## 性能优化策略

### 1. 缓存策略
- **模型缓存**: 将加载的模型保存在内存中
- **结果缓存**: 预测结果缓存到Redis，设置TTL
- **会话缓存**: 用户会话信息缓存到Redis

### 2. 异步处理
- **任务队列**: 使用Celery处理耗时任务
- **批量处理**: 支持批量图像处理
- **优先级队列**: 高优先级任务优先处理

### 3. 负载均衡
- **服务多实例**: 每个服务部署多个实例
- **数据库读写分离**: 主从复制，读写分离
- **CDN加速**: 静态资源使用CDN分发

### 4. 资源优化
- **GPU共享**: 多个模型服务共享GPU资源
- **内存管理**: 及时释放不用的模型
- **连接池**: 数据库和Redis连接池

## 安全设计

### 1. 认证授权
- **JWT Token**: 用户身份认证
- **RBAC**: 基于角色的访问控制
- **API密钥**: 第三方服务访问控制

### 2. 数据安全
- **传输加密**: HTTPS/WSS加密传输
- **存储加密**: 敏感数据加密存储
- **数据脱敏**: 日志中敏感信息脱敏

### 3. 访问控制
- **IP白名单**: 限制服务间访问
- **请求限流**: 防止API滥用
- **防火墙**: 网络层访问控制

## 监控与运维

### 1. 监控指标
- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: 请求量、响应时间、错误率
- **业务指标**: 任务量、处理成功率、用户活跃度

### 2. 日志管理
- **结构化日志**: 统一日志格式
- **日志聚合**: 集中收集和分析
- **告警机制**: 异常自动告警

### 3. 健康检查
- **服务健康**: 各服务健康状态检查
- **依赖检查**: 数据库、Redis等依赖检查
- **自动恢复**: 服务异常自动重启

## 扩展性设计

### 1. 水平扩展
- **无状态服务**: 业务服务无状态设计
- **自动扩缩容**: 根据负载自动调整实例数
- **分片策略**: 数据分片存储

### 2. 功能扩展
- **插件机制**: 支持模型插件扩展
- **多租户**: 支持多租户隔离
- **国际化**: 多语言支持

## 项目目录结构

```
plant-disease-microservices/
├── services/                   # 微服务目录
│   ├── api-gateway/           # API网关
│   ├── user-service/          # 用户服务
│   ├── task-service/          # 任务服务
│   ├── model-service/         # 模型服务
│   ├── segmentation-service/  # 分割服务
│   └── notification-service/  # 通知服务
├── frontend/                   # 前端应用
│   ├── web/                   # Web前端
│   └── mobile/                # 移动应用
├── shared/                     # 共享代码
│   ├── database/              # 数据库模型
│   ├── utils/                 # 工具函数
│   └── schemas/               # 数据模式
├── infrastructure/             # 基础设施
│   ├── docker/                # Docker配置
│   ├── kubernetes/            # K8s配置
│   ├── monitoring/            # 监控配置
│   └── scripts/               # 部署脚本
├── docs/                       # 文档
├── tests/                      # 测试
└── docker-compose.yml          # 开发环境配置
```

这个架构设计提供了一个完整的、可扩展的植物病害检测系统，采用微服务架构，支持高并发、高可用和弹性扩展。